<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Final-Rank-Elite Admin</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h1>Final-Rank-Elite Admin Leaderboard</h1>

<nav>
  <a href="tutorial.html">Rules Tutorial</a>
  <a href="history.html">Tournament History</a>
</nav>

<!-- Copy JSON Button -->
<button id="copyJsonBtn">Copy JSON</button>

<table id="leaderboard">
  <thead>
    <tr>
      <th>Rank</th>
      <th>Username</th>
      <th>Net Wins CM</th>
      <th>Net Wins ST</th>
      <th>CM $</th>
      <th>ST $</th>
      <th>Total $</th>
      <th>Winrate CM</th>
      <th>Winrate ST</th>
      <th>Reset Earnings</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script src="config.js"></script>
<script src="ledger.js"></script>
<script src="lichess.js"></script>
<script src="calc.js"></script>
<script>
async function renderLeaderboard() {
  const teamMembers = await Lichess.fetchTeamMembers();
  const tournaments = await Lichess.fetchTeamTournaments(CONFIG.manualTournamentIDs);
  const results = await Lichess.fetchTournamentResults(tournaments);

  const payouts = Calc.calculatePayouts(teamMembers, results, ledger);

  const tbody = document.querySelector("#leaderboard tbody");
  tbody.innerHTML = "";

  payouts.forEach((player, idx) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${player.username}</td>
      <td>${player.netWinsCM}</td>
      <td>${player.netWinsST}</td>
      <td>$${player.earningsCM.toFixed(2)}</td>
      <td>$${player.earningsST.toFixed(2)}</td>
      <td>$${player.totalEarnings.toFixed(2)}</td>
      <td>${(player.winrateCM*100).toFixed(1)}%</td>
      <td>${(player.winrateST*100).toFixed(1)}%</td>
      <td>
        <button onclick="ledger.resetEarnings('${player.username}', 'chessMood'); renderLeaderboard();">Reset CM</button>
        <button onclick="ledger.resetEarnings('${player.username}', 'streamers'); renderLeaderboard();">Reset ST</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Store last rendered payouts for copy JSON button
  window.lastLeaderboardJSON = JSON.stringify(payouts, null, 2);
}

// Initial render
renderLeaderboard();

// Copy JSON Button Functionality
document.getElementById("copyJsonBtn").addEventListener("click", () => {
  if (window.lastLeaderboardJSON) {
    navigator.clipboard.writeText(window.lastLeaderboardJSON)
      .then(() => alert("Leaderboard JSON copied to clipboard!"))
      .catch(err => alert("Failed to copy JSON: " + err));
  } else {
    alert("Leaderboard not ready yet.");
  }
});
</script>
</body>
</html>
